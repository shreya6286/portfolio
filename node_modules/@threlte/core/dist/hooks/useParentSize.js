import { onDestroy } from 'svelte';
import { currentWritable } from '../lib/storeUtils';
import { browser } from '../lib/browser';
export const useParentSize = () => {
    const parentSize = currentWritable({ width: 0, height: 0 });
    if (!browser) {
        return {
            parentSize,
            parentSizeAction: () => {
                /* do nothing */
            }
        };
    }
    // Only observe childList changes of the parent
    const mutationOptions = { childList: true, subtree: false, attributes: false };
    let el;
    const observeParent = (parent) => {
        resizeObserver.disconnect();
        mutationObserver.disconnect();
        resizeObserver.observe(parent);
        mutationObserver.observe(parent, mutationOptions);
    };
    // The canvas should match the contentRect of its parent
    const resizeObserver = new ResizeObserver(([entry]) => {
        const { width, height } = entry.contentRect;
        if (width === parentSize.current.width && height === parentSize.current.height)
            return;
        parentSize.set({ width, height });
    });
    // Use a mutation observer to detect reparenting
    const mutationObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            for (const node of mutation.removedNodes) {
                if (el === node && el.parentElement) {
                    observeParent(el.parentElement);
                    return;
                }
            }
        }
    });
    const parentSizeAction = (node) => {
        el = node;
        const parent = el.parentElement;
        if (!parent)
            return;
        parentSize.set({
            width: parent.clientWidth,
            height: parent.clientHeight
        });
        observeParent(parent);
    };
    onDestroy(() => {
        resizeObserver.disconnect();
        mutationObserver.disconnect();
    });
    return {
        parentSize,
        parentSizeAction
    };
};
